<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì •ì•„ì¸ì˜ í•˜ëŠ˜ ë‚˜ë¬´ ìˆ˜í•™ ëª¨í—˜</title>
    <style>
        @font-face {
            font-family: 'NexonGothic';
            src: url('./NexonLv2Gothic_2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @import url('https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap');

        :root {
            --sky-top: #4facfe;
            --sky-bottom: #a1eafb;
            --tree-deep: #3e2723;
            --tree-mid: #5d4037;
            --tree-light: #795548;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'NexonGothic', sans-serif; 
            background: var(--sky-bottom); 
            user-select: none; 
            touch-action: manipulation; 
        }

        #game-container { 
            position: relative; width: 100vw; height: 100vh; 
            background: linear-gradient(to bottom, var(--sky-top) 0%, var(--sky-bottom) 100%); 
            overflow: hidden; 
        }
        
        .cloud {
            position: absolute; background: white; border-radius: 50px; opacity: 0.6;
            filter: blur(3px); animation: float 15s infinite linear;
        }
        @keyframes float { from { transform: translateX(-150px); } to { transform: translateX(110vw); } }

        #game-world { position: relative; width: 100vw; height: 100vh; transition: transform 0.8s ease-in-out; }

        .giant-tree { 
            position: absolute; left: 50%; bottom: -2000px; width: 320px; height: 6000px; 
            background: linear-gradient(90deg, var(--tree-deep) 0%, var(--tree-mid) 25%, var(--tree-light) 50%, var(--tree-mid) 75%, var(--tree-deep) 100%);
            transform: translateX(-50%); border-radius: 60px; z-index: 1; 
            box-shadow: inset 0 0 80px rgba(0,0,0,0.5);
        }

        .stair { 
            position: absolute; width: 130px; height: 25px; 
            background: linear-gradient(to bottom, #fff59d, #fbc02d); 
            border-radius: 20px; z-index: 5; border: 2px solid #f9a825; 
            box-shadow: 0 5px 10px rgba(0,0,0,0.2); 
        }

        #rabbit-group { position: absolute; z-index: 10; transition: all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #rabbit { font-size: 65px; line-height: 1; }

        #rabbit-bubble {
            position: absolute;
            background: #fff; border: 3px solid #ff80ab; padding: 5px 12px;
            border-radius: 15px; 
            font-family: 'Nanum Pen Script', cursive; 
            font-size: 26px; font-weight: 800;
            color: #d81b60; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: none; z-index: 11;
            top: 0;
        }

        #rabbit-bubble::after { 
            content: ''; position: absolute; 
            border-style: solid; 
        }

        #ui-layer { position: absolute; top: 10px; left: 0; width: 100%; pointer-events: none; z-index: 100; display: flex; flex-direction: column; align-items: center; }
        #quiz-box {
            pointer-events: auto; display: none; background: rgba(255, 255, 255, 0.98);
            padding: 12px; border-radius: 25px; border: 5px solid #81c784;
            text-align: center; width: 75%; max-width: 280px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #remain-info { font-size: 16px; color: #000; font-weight: bold; margin-bottom: 5px; }
        #timer { font-size: 24px; color: #000; font-weight: bold; margin-bottom: 5px; }
        #question { font-size: 38px; margin: 5px 0; color: #2e7d32; font-weight: 800; }
        
        #options-container { display: flex; justify-content: space-around; gap: 8px; }
        .option-btn { 
            flex: 1; font-family: 'NexonGothic', sans-serif; font-size: 26px; padding: 8px; 
            background: #fff; border: 3px solid #66bb6a; border-radius: 12px; 
            cursor: pointer; font-weight: bold; color: #2e7d32; box-shadow: 0 4px 0 #388e3c; 
        }

        #stats-screen { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 25px; border-radius: 30px; border: 8px solid #ffd54f; 
            text-align: center; display: none; z-index: 200; width: 65%; max-width: 260px; 
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="cloud" style="top: 10%; width: 120px; height: 40px; animation-delay: 0s;"></div>
    <div class="cloud" style="top: 30%; width: 180px; height: 60px; animation-delay: -5s;"></div>
    <div id="game-world">
        <div class="giant-tree"></div>
        <div id="stair-container"></div>
        <div id="rabbit-group">
            <div id="rabbit-bubble"></div>
            <div id="rabbit">ğŸ°</div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="quiz-box">
            <div id="remain-info"></div>
            <div id="timer">ğŸ•’ 20</div>
            <div id="question"></div>
            <div id="options-container"></div>
        </div>
    </div>

    <div id="stats-screen">
        <h1 style="color: #f57c00; font-size: 22px;">ì •ì•„ì¸ ê²°ê³¼</h1>
        <p id="stats-content" style="font-size: 18px; line-height: 2.2; font-weight: bold;"></p>
        <div id="reward-icon" style="font-size: 50px; margin: 10px;"></div>
        <button onclick="location.reload()" style="font-size: 18px; padding: 8px 20px; background: #ffa726; color: #fff; border: none; border-radius: 20px; cursor: pointer; font-family: 'NexonGothic', sans-serif;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
</div>

<script>
    const audioCorrect = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'); 
    const audioWin = new Audio('https://assets.mixkit.co/active_storage/sfx/1432/1432-preview.mp3');

    const gameWorld = document.getElementById('game-world');
    const rabbitGroup = document.getElementById('rabbit-group');
    const rabbitBubble = document.getElementById('rabbit-bubble');
    const quizBox = document.getElementById('quiz-box');
    const questionEl = document.getElementById('question');
    const optionsContainer = document.getElementById('options-container');
    const timerEl = document.getElementById('timer');
    const remainEl = document.getElementById('remain-info');
    const stairContainer = document.getElementById('stair-container');

    let currentLvl = 0;
    let score = 0;
    let timer;
    let timeLeft = 20; // 3. ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œê°„ 20ì´ˆë¡œ ê³ ì •
    let correctVal = 0;
    const totalQuest = 20;

    const cheerMessages = [
        "ì•„ì¸ì´ ì˜í•œë‹¤!", "ì•„ì¸ì•„ í˜ë‚´!", "ì†Œì›ê¶Œ ê°€ì~", "ì¢‹ì•„! ì¢‹ì•„!", 
        "ì•„ì¸ì•„ ì¡°ê¸ˆë§Œ ë”!", "ì•„ì¸ì´ êµ³! êµ³!", "ì•„ì¸ì´ ìµœê³ !", "ì•„ì¸ì´ í™”ì´íŒ…!", 
        "ì¡°ê¸ˆë§Œ ë”!", "í˜ë‚´ë¼ í˜!", "ì™€ì•„ ì§„ì§œ ìµœê³ !"
    ];

    function initStairs() {
        for (let i = 0; i < totalQuest + 5; i++) {
            const s = document.createElement('div');
            s.className = 'stair';
            const angle = i * 0.9;
            const x = Math.sin(angle) * 120 + (window.innerWidth / 2) - 65;
            const y = window.innerHeight - (i * 90) - 120;
            s.style.left = x + 'px';
            s.style.top = y + 'px';
            s.style.zIndex = Math.cos(angle) > 0 ? 6 : 2;
            stairContainer.appendChild(s);
        }
    }

    function updateCamera() {
        const offset = currentLvl * 90;
        const cameraY = offset - (window.innerHeight / 2) + 150;
        if (currentLvl > 1) {
            gameWorld.style.transform = `translateY(${cameraY}px)`;
        }
    }

    function updateRabbitPosition() {
        const angle = currentLvl * 0.9;
        const centerX = window.innerWidth / 2;
        const rabbitX = Math.sin(angle) * 120 + centerX - 65;
        const y = window.innerHeight - (currentLvl * 90) - 185; 
        
        rabbitGroup.style.left = rabbitX + 'px';
        rabbitGroup.style.top = y + 'px';
        rabbitGroup.style.zIndex = Math.cos(angle) > 0 ? 10 : 3;

        if (rabbitX + 32 < centerX) { 
            rabbitBubble.style.left = "75px";
            rabbitBubble.style.right = "auto";
            applyBubbleTail('right');
        } else {
            rabbitBubble.style.left = "auto";
            rabbitBubble.style.right = "75px";
            applyBubbleTail('left');
        }
    }

    function applyBubbleTail(direction) {
        const style = document.createElement('style');
        if (direction === 'right') {
            style.innerHTML = `#rabbit-bubble::after { left: -10px; right: auto; border-width: 8px 10px 8px 0; border-color: transparent #ff80ab transparent transparent; top: 15px; }`;
        } else {
            style.innerHTML = `#rabbit-bubble::after { right: -10px; left: auto; border-width: 8px 0 8px 10px; border-color: transparent transparent transparent #ff80ab; top: 15px; }`;
        }
        const oldStyle = document.getElementById('bubble-tail-style');
        if (oldStyle) oldStyle.remove();
        style.id = 'bubble-tail-style';
        document.head.appendChild(style);
    }

    function showRabbitSpeech(msg) {
        rabbitBubble.innerText = msg;
        rabbitBubble.style.display = 'block';
        setTimeout(() => rabbitBubble.style.display = 'none', 2000);
    }

    function makeQuiz() {
        let a, b;
        // 1, 4. ë‚œì´ë„ ì¡°ì ˆ: ë¬´ì¡°ê±´ ë‘ìë¦¬ ìˆ˜ ë° ì •ë‹µ 99 ì´í•˜
        if (currentLvl <= 15) {
            // ì¡°ê¸ˆ ì‰¬ìš´ ë¬¸ì œ (ë°›ì•„ì˜¬ë¦¼ ì ê²Œ)
            a = Math.floor(Math.random() * 40) + 10;
            b = Math.floor(Math.random() * 40) + 10;
        } else {
            // ì¡°ê¸ˆ ì–´ë ¤ìš´ ë¬¸ì œ (í° ìˆ˜ë“¤)
            a = Math.floor(Math.random() * 40) + 50;
            b = Math.floor(Math.random() * (99 - a - 10)) + 10;
        }
        
        // 2. ì •ë‹µ 99 ë„˜ì§€ ì•Šê²Œ ë³´ì • (ëœë¤ ë²”ìœ„ì—ì„œ ì‹¤íŒ¨í•  ê²½ìš° ëŒ€ë¹„)
        correctVal = a + b;
        if(correctVal > 99) {
            a = 45; b = 34; correctVal = 79;
        }

        questionEl.innerText = `${a} + ${b} = ?`;
        remainEl.innerText = `ë‚¨ì€ ë¬¸ì œ: ${totalQuest - currentLvl}ê°œ`;

        // 5. ì •ë‹µ í¬í•¨ ë³´ê¸° 3ê°œì˜ ëìë¦¬ ìˆ˜ ë™ì¼í•˜ê²Œ ì„¤ì •
        const lastDigit = correctVal % 10;
        let opt2 = correctVal + 10;
        if(opt2 > 99) opt2 = correctVal - 10;
        
        let opt3 = correctVal + 20;
        if(opt3 > 99) opt3 = correctVal - 20;
        if(opt3 === opt2) opt3 = correctVal - 30;

        const options = [correctVal, opt2, opt3].sort(() => Math.random() - 0.5);
        optionsContainer.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt);
            optionsContainer.appendChild(btn);
        });
    }

    async function startTurn() {
        if (currentLvl >= totalQuest) { endGame(true); return; }
        updateCamera(); 
        currentLvl++;
        updateRabbitPosition();
        setTimeout(() => {
            const randomMsg = cheerMessages[Math.floor(Math.random() * cheerMessages.length)];
            showRabbitSpeech(randomMsg);
            quizBox.style.display = 'block';
            makeQuiz();
            startTimer();
        }, 800);
    }

    function startTimer() {
        timeLeft = 20; // 3. 20ì´ˆ ì´ˆê¸°í™”
        timerEl.innerText = `ğŸ•’ ${timeLeft}`;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            timerEl.innerText = `ğŸ•’ ${timeLeft}`;
            if (timeLeft <= 0) endGame(false, "ì‹œê°„ì´ ë‹¤ ëì–´ìš”!");
        }, 1000);
    }

    function checkAnswer(val) {
        if (val === correctVal) {
            clearInterval(timer);
            score++;
            audioCorrect.play();
            quizBox.style.display = 'none';
            setTimeout(startTurn, 500);
        } else {
            endGame(false, "ì•—! í‹€ë ¸ì–´ìš”.");
        }
    }

    function endGame(win, msg="") {
        clearInterval(timer);
        quizBox.style.display = 'none';
        const screen = document.getElementById('stats-screen');
        screen.style.display = 'block';
        if (win) {
            audioWin.play();
            document.getElementById('stats-content').innerText = `ëŒ€ë‹¨í•´ ì •ì•„ì¸!\nì „ë¶€ ë§í˜”ì–´!\nì ìˆ˜: 100ì !`;
            document.getElementById('reward-icon').innerText = "ğŸŸï¸ ì†Œì›ê¶Œ";
        } else {
            document.getElementById('stats-content').innerText = `${msg}\n${score}ë¬¸ì œë¥¼ ë§í˜”ì–´.\nì ìˆ˜: ${(score/totalQuest)*100}ì `;
            document.getElementById('reward-icon').innerText = "â­";
        }
    }

    initStairs();
    updateRabbitPosition();
    setTimeout(startTurn, 1000);
</script>
</body>
</html>