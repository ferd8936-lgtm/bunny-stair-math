<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì•„ì´ë‹ˆì˜ í•˜ëŠ˜ë‚˜ë¬´ ìˆ˜í•™êµì‹¤</title>
    <style>
        @font-face {
            font-family: 'NexonGothic';
            src: url('./NexonLv2Gothic_2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        * { font-family: 'NexonGothic', sans-serif !important; }

        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            user-select: none; 
            touch-action: manipulation; 
        }

        #game-container { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
            max-width: 600px; 
            margin: 0 auto;
            background: url('background.png') no-repeat center center / cover; 
            overflow: hidden; 
        }

        #start-screen {
            position: absolute; width: 100%; height: 100%; z-index: 500;
            background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .start-rabbit { width: 120px; height: 120px; margin-bottom: 10px; animation: bounce 2s infinite; background: url('abc.png') no-repeat center/contain; }
        .game-title { font-size: 34px; color: #2e7d32; font-weight: 800; margin-bottom: 30px; text-align: center; }
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 90%; }
        .step-btn {
            padding: 15px 5px; font-size: 17px; font-weight: bold; border-radius: 15px;
            background: #fff; border: 3px solid #81c784; color: #2e7d32; cursor: pointer;
            box-shadow: 0 4px 0 #66bb6a;
        }

        #game-world { position: relative; width: 100%; height: 100%; transition: transform 0.8s ease-in-out; }

        .stair { 
            position: absolute; width: 110px; height: 26px; 
            background: linear-gradient(to bottom, #795548 0%, #5d4037 50%, #3e2723 100%); 
            border: 2px solid #2b1d1a;
            border-radius: 6px;
            left: 50%; transform: translateX(-50%); z-index: 5;
            box-shadow: 0 5px 8px rgba(0,0,0,0.5);
        }
        .stair::before, .stair::after {
            content: ''; position: absolute; top: -80px; width: 5px; height: 85px;
            background: linear-gradient(to right, #a1887f, #8d6e63, #795548); 
            border-radius: 3px; z-index: -1;
            box-shadow: 1px 0 3px rgba(0,0,0,0.3);
        }
        .stair::before { left: 8px; }
        .stair::after { right: 8px; }

        #rabbit-group { position: absolute; z-index: 20; transition: all 0.7s ease-in-out; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; }
        #rabbit { width: 100px; height: 100px; background: url('abc.png') no-repeat center/contain; }

        #rabbit-bubble {
            position: absolute; background: #fff; border: 3px solid #ff80ab; padding: 5px 10px;
            border-radius: 15px; font-size: 16px; font-weight: 800; color: #d81b60;
            white-space: nowrap; display: none; bottom: 105px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #rabbit-bubble::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            border-width: 10px 8px 0 8px; border-style: solid; border-color: #ff80ab transparent transparent transparent;
        }

        #ui-layer { position: absolute; top: 20px; left: 0; width: 100%; pointer-events: none; z-index: 100; display: flex; flex-direction: column; align-items: center; }
        
        #quiz-box, .result-pop { 
            pointer-events: auto; display: none; background: rgba(255, 255, 255, 0.98); 
            padding: 15px; border-radius: 30px; border: 6px solid #81c784; 
            text-align: center; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        #question { font-size: 32px; margin: 10px 0; color: #2e7d32; font-weight: 900; }
        #numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .num-btn { font-size: 20px; padding: 10px 0; background: #fff; border: 2px solid #81c784; border-radius: 10px; font-weight: 800; }
        .control-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; color: #fff; margin-top: 10px; cursor: pointer; }

        #stats-screen { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 600; display: none !important; width: 100%; justify-content: center; 
        }

        #wish-ticket {
            display: none;
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #fff;
            padding: 15px;
            border-radius: 20px;
            border: 4px dashed #fff;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            margin: 15px 0;
            position: relative;
            animation: shine 1.5s infinite;
        }
        #wish-ticket span {
            display: block;
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes shine {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #victory-effect {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 550; display: none; pointer-events: none;
            background: radial-gradient(circle at center, rgba(255,255,200,0.8) 0%, transparent 70%);
            animation: sun-glare 3s ease-in-out forwards;
        }
        @keyframes sun-glare {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); background-color: rgba(255, 255, 255, 0.4); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="victory-effect"></div>

    <div id="start-screen">
        <div class="start-rabbit"></div>
        <div class="game-title">ì•„ì´ë‹ˆì˜<br>í•˜ëŠ˜ë‚˜ë¬´ ìˆ˜í•™êµì‹¤</div>
        <div class="btn-grid">
            <button class="step-btn" onclick="playMusic(); startGame(1)">1ë‹¨ê³„<br>(ë‘ìë¦¬ ë°›ì•„ì˜¬ë¦¼)</button>
            <button class="step-btn" onclick="playMusic(); startGame(2)">2ë‹¨ê³„<br>(ì„¸ìë¦¬ ë°›ì•„ì˜¬ë¦¼)</button>
            <button class="step-btn" onclick="playMusic(); startGame(3)">3ë‹¨ê³„<br>(ë‘ìë¦¬ ë°›ì•„ë‚´ë¦¼)</button>
            <button class="step-btn" onclick="playMusic(); startGame(4)">4ë‹¨ê³„<br>(ì„¸ìë¦¬ ë°›ì•„ë‚´ë¦¼)</button>
        </div>
    </div>

    <div id="game-world">
        <div id="stair-container"></div>
        <div id="rabbit-group">
            <div id="rabbit-bubble"></div>
            <div id="rabbit"></div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="quiz-box">
            <div id="remain-info" style="font-weight: bold; color: #666;"></div>
            <div id="timer" style="color: #ff5252; font-weight: bold;">ğŸ•’ 20</div>
            <div id="question"></div>
            <div id="numpad">
                <button class="num-btn" onclick="addNum(1)">1</button>
                <button class="num-btn" onclick="addNum(2)">2</button>
                <button class="num-btn" onclick="addNum(3)">3</button>
                <button class="num-btn" onclick="addNum(4)">4</button>
                <button class="num-btn" onclick="addNum(5)">5</button>
                <button class="num-btn" onclick="addNum(6)">6</button>
                <button class="num-btn" onclick="addNum(7)">7</button>
                <button class="num-btn" onclick="addNum(8)">8</button>
                <button class="num-btn" onclick="addNum(9)">9</button>
                <button class="num-btn" onclick="addNum(0)">0</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="control-btn" style="background:#ef5350;" onclick="clearAns()">ì§€ìš°ê¸°</button>
                <button class="control-btn" style="background:#66bb6a;" onclick="checkAnswer()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="stats-screen">
        <div class="result-pop" style="display: block;">
            <h1 id="stats-title" style="color: #f57c00; font-size: 22px; margin-bottom: 5px;"></h1>
            <div id="stats-step-info" style="font-size: 15px; color: #666; margin-bottom: 10px;"></div>
            <p id="stats-content" style="font-weight: bold; font-size: 18px; line-height: 1.6;"></p>
            
            <div id="wish-ticket">
                <span>â­ ì¶•í•˜í•´! â­</span>
                <span>ğŸŸï¸ ì†Œì›ê¶Œ íšë“! ğŸŸï¸</span>
            </div>

            <div style="width: 80px; height: 80px; margin: 10px auto; background: url('abc.png') no-repeat center/contain;"></div>
            <button onclick="location.reload()" style="padding: 12px 25px; background: #ffa726; color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 18px; font-weight: bold;">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // ì˜¤ë””ì˜¤ ì„¤ì •
    const audioWin = new Audio('https://assets.mixkit.co/active_storage/sfx/1432/1432-preview.mp3');
    const bgMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3'); // ë” ì•ˆì •ì ì¸ ì£¼ì†Œë¡œ êµì²´
    bgMusic.loop = true;
    bgMusic.volume = 0.3;

    let audioCtx = null;
    let isMusicPlaying = false;

    // ë°°ê²½ìŒì•… ê°•ì œ ì¬ìƒ í•¨ìˆ˜
    function playMusic() {
        if (!isMusicPlaying) {
            bgMusic.play().then(() => {
                isMusicPlaying = true;
            }).catch(e => console.log("ìŒì•… ì¬ìƒ ëŒ€ê¸° ì¤‘..."));
        }
    }

    function playCuteSound() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + 0.15);
        
        gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
    }

    let currentLvl = 0;
    let score = 0;
    let timer;
    let timeLeft = 20;
    let correctVal = 0;
    let inputVal = "";
    let gameStep = 1;
    let currentQuizStr = "";
    const totalQuest = 15;
    const cheerMessages = ["ì¢‹ì•„!ì¢‹ì•„!", "ì˜í•œë‹¤!", "í™”ì´íŒ…!", "í˜ë‚´!", "ì†Œì›ê¶Œ ê°€ì!", "ë©‹ì§€ë‹¤!", "ì¡°ê¸ˆë§Œ ë”!", "ì§‘ì¤‘!ì§‘ì¤‘!"];

    function startGame(step) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        gameStep = step;
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('stats-screen').style.setProperty('display', 'none', 'important');
        
        initStairs();
        updateRabbitPosition();
        setTimeout(startTurn, 500);
    }

    function initStairs() {
        const container = document.getElementById('stair-container');
        container.innerHTML = '';
        for (let i = 0; i <= totalQuest; i++) {
            const s = document.createElement('div');
            s.className = 'stair';
            s.style.bottom = (i * 80) + 100 + 'px';
            container.appendChild(s);
        }
    }

    function updateRabbitPosition() {
        const y = (currentLvl * 80) + 120;
        document.getElementById('rabbit-group').style.bottom = y + 'px';
        const targetY = (currentLvl * 80) - (window.innerHeight * 0.15);
        document.getElementById('game-world').style.transform = `translateY(${targetY}px)`;
    }

    function showSpeech() {
        const b = document.getElementById('rabbit-bubble');
        b.innerText = cheerMessages[Math.floor(Math.random() * cheerMessages.length)];
        b.style.display = 'block';
        setTimeout(() => b.style.display = 'none', 2000);
    }

    function makeQuiz() {
        let a, b;
        let finalAns = 0;
        do {
            if (gameStep === 1) { 
                let a_ten = Math.floor(Math.random() * 4) + 1;
                let a_one = Math.floor(Math.random() * 8) + 1;
                let b_ten = Math.floor(Math.random() * (8 - a_ten)) + 1;
                let b_one = Math.floor(Math.random() * (9 - a_one)) + (10 - a_one); 
                if (b_one > 9) b_one = 9;
                a = a_ten * 10 + a_one; b = b_ten * 10 + b_one;
                finalAns = a + b;
            } else if (gameStep === 2) { 
                let a_h = Math.floor(Math.random() * 3) + 1;
                let a_t = Math.floor(Math.random() * 4) + 1;
                let a_o = Math.floor(Math.random() * 8) + 1;
                let b_h = Math.floor(Math.random() * 3) + 1;
                let b_t = Math.floor(Math.random() * 4) + 1;
                let b_o = Math.floor(Math.random() * (9 - a_o)) + (10 - a_o);
                a = a_h * 100 + a_t * 10 + a_o; b = b_h * 100 + b_t * 10 + b_o;
                finalAns = a + b;
            } else if (gameStep === 3) { 
                let a_t = Math.floor(Math.random() * 7) + 2;
                let a_o = Math.floor(Math.random() * 8);
                let b_t = Math.floor(Math.random() * (a_t - 1)) + 1;
                let b_o = Math.floor(Math.random() * (9 - (a_o + 1))) + (a_o + 1);
                a = a_t * 10 + a_o; b = b_t * 10 + b_o;
                finalAns = a - b;
            } else { 
                let a_h = Math.floor(Math.random() * 5) + 4;
                let a_t = Math.floor(Math.random() * 4) + 5;
                let a_o = Math.floor(Math.random() * 8);
                let b_h = Math.floor(Math.random() * (a_h - 1)) + 1;
                let b_t = Math.floor(Math.random() * (a_t - 1)) + 1;
                let b_o = Math.floor(Math.random() * (9 - (a_o + 1))) + (a_o + 1);
                a = a_h * 100 + a_t * 10 + a_o; b = b_h * 100 + b_t * 10 + b_o;
                finalAns = a - b;
            }
        } while (finalAns % 10 === 0);
        correctVal = finalAns;
        currentQuizStr = `${a} ${gameStep <= 2 ? '+' : '-'} ${b} = `;
        document.getElementById('question').innerText = currentQuizStr + "?";
        document.getElementById('remain-info').innerText = `ë‚¨ì€ ë¬¸ì œ: ${totalQuest - currentLvl}ê°œ`;
        inputVal = "";
    }

    function startTurn() {
        if (currentLvl >= totalQuest) { showVictoryEffect(); return; }
        currentLvl++;
        
        playCuteSound();
        
        updateRabbitPosition();
        setTimeout(() => {
            showSpeech();
            document.getElementById('quiz-box').style.display = 'block';
            makeQuiz();
            startTimer();
        }, 800);
    }

    function showVictoryEffect() {
        const effect = document.getElementById('victory-effect');
        effect.style.display = 'block';
        const finalY = (totalQuest * 80) - (window.innerHeight * 0.5);
        document.getElementById('game-world').style.transform = `translateY(${finalY + 200}px) scale(1.1)`;
        setTimeout(() => { endGame(true); }, 2500);
    }

    function startTimer() {
        timeLeft = 20;
        document.getElementById('timer').innerText = `ğŸ•’ ${timeLeft}`;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = `ğŸ•’ ${timeLeft}`;
            if (timeLeft <= 0) endGame(false, "ì‹œê°„ ì´ˆê³¼!");
        }, 1000);
    }

    function addNum(n) { 
        if(inputVal.length < 4) { inputVal += n; document.getElementById('question').innerText = currentQuizStr + inputVal; } 
    }
    function clearAns() { inputVal = ""; document.getElementById('question').innerText = currentQuizStr + "?"; }

    function checkAnswer() {
        if (inputVal === "" || parseInt(inputVal) !== correctVal) { endGame(false, "í‹€ë ¸ì–´ìš”!"); return; }
        clearInterval(timer);
        score++;
        document.getElementById('quiz-box').style.display = 'none';
        setTimeout(startTurn, 300);
    }

    function endGame(win, msg) {
        clearInterval(timer);
        document.getElementById('quiz-box').style.display = 'none';
        const screen = document.getElementById('stats-screen');
        screen.style.setProperty('display', 'flex', 'important');
        const steps = ["", "1ë‹¨ê³„(ë‘ìë¦¬ ë°›ì•„ì˜¬ë¦¼)", "2ë‹¨ê³„(ì„¸ìë¦¬ ë°›ì•„ì˜¬ë¦¼)", "3ë‹¨ê³„(ë‘ìë¦¬ ë°›ì•„ë‚´ë¦¼)", "4ë‹¨ê³„(ì„¸ìë¦¬ ë°›ì•„ë‚´ë¦¼)"];
        document.getElementById('stats-step-info').innerText = win ? steps[gameStep] : "";
        document.getElementById('stats-title').innerText = win ? "ëŒ€ì„±ê³µ! ğŸ‰" : "ì•„ì‰¬ì›Œìš”";
        document.getElementById('stats-content').innerText = `${totalQuest}ë¬¸ì œ ì¤‘ ${score}ë¬¸ì œë¥¼ ë§í˜”ì–´ìš”!`;
        if (win) {
            audioWin.play();
            document.getElementById('wish-ticket').style.display = 'block';
        } else {
            document.getElementById('wish-ticket').style.display = 'none';
        }
    }
</script>
</body>
</html>
