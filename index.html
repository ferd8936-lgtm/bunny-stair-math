<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì •ì•„ì¸ì˜ í•˜ëŠ˜ ë‚˜ë¬´ ìˆ˜í•™ ëª¨í—˜</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Nanum+Gothic:wght@700;800&display=swap');

        :root {
            --tree-brown: #6d4c41;
            --sky-blue: #e1f5fe;
            --btn-green: #66bb6a;
        }

        body { margin: 0; overflow: hidden; font-family: 'Nanum Gothic', sans-serif; background: var(--sky-blue); user-select: none; touch-action: manipulation; }

        /* ë°°ê²½ ë° ì›”ë“œ ìŠ¤í¬ë¡¤ */
        #game-world { position: relative; width: 100vw; height: 100vh; transition: transform 0.8s ease-in-out; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: linear-gradient(to bottom, #81d4fa 0%, #e1f5fe 100%); overflow: hidden; }

        .giant-tree { position: absolute; left: 50%; bottom: -1000px; width: 280px; height: 5000px; background: linear-gradient(90deg, #5d4037, #8d6e63, #5d4037); transform: translateX(-50%); border-radius: 60px; z-index: 1; box-shadow: inset 0 0 50px rgba(0,0,0,0.3); }
        .stair { position: absolute; width: 130px; height: 25px; background: linear-gradient(to bottom, #fff59d, #fbc02d); border-radius: 20px; z-index: 5; border: 2px solid #f9a825; }

        /* ìºë¦­í„° */
        #rabbit { position: absolute; font-size: 65px; z-index: 10; transition: all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #monster { position: absolute; font-size: 75px; z-index: 9; display: none; }

        /* í† ë¼ ë§í’ì„  (ì‚¬ì´ì¦ˆ ì¶•ì†Œ ë° ìœ„ì¹˜ ì¡°ì •) */
        .rabbit-speech {
            position: absolute; background: #fff; border: 3px solid #ff80ab; padding: 8px 15px;
            border-radius: 20px; font-family: 'Nanum Pen Script', cursive; font-size: 24px; font-weight: 800;
            color: #d81b60; z-index: 20; white-space: nowrap; transform: translate(-80%, -100%); /* ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;
        }
        .rabbit-speech::after { content: ''; position: absolute; bottom: -12px; right: 20px; border-width: 12px 12px 0; border-style: solid; border-color: #ff80ab transparent; }

        /* ìƒë‹¨ ìŠ¬ë¦¼ íŒì—… (ê°€ë¡œ í¬ê¸° ì¶•ì†Œ ë° ê¸€ì í†µì¼) */
        #ui-layer { position: absolute; top: 10px; left: 0; width: 100%; pointer-events: none; z-index: 100; display: flex; flex-direction: column; align-items: center; }
        
        #quiz-box {
            pointer-events: auto; display: none; background: rgba(255, 255, 255, 0.98);
            padding: 15px; border-radius: 25px; border: 5px solid #81c784;
            text-align: center; width: 80%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        #progress-text, #timer { font-size: 20px; color: #666; font-weight: bold; margin: 2px; }
        #question { font-size: 35px; margin: 10px 0; color: #2e7d32; font-weight: 800; }
        
        #options-container { display: flex; justify-content: space-around; gap: 8px; margin-top: 5px; }
        .option-btn {
            flex: 1; font-size: 24px; padding: 8px; background: #fff;
            border: 3px solid #66bb6a; border-radius: 12px; cursor: pointer;
            font-weight: bold; color: #2e7d32; box-shadow: 0 4px 0 #388e3c;
        }

        /* ê²°ê³¼ í™”ë©´ (ì‚¬ì´ì¦ˆ ì¶•ì†Œ ë° ì¤„ê°„ê²© ì¡°ì •) */
        #stats-screen { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 25px; border-radius: 30px; border: 8px solid #ffd54f; 
            text-align: center; display: none; z-index: 200; width: 70%; max-width: 280px;
        }
        #stats-content { font-size: 18px; line-height: 2.2; color: #444; font-weight: bold; } /* ì¤„ê°„ê²© ë„ì›€ */
        #stats-title { font-size: 24px; margin: 10px; }

        @keyframes popUp { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2) translateY(-50px); opacity: 0; } }
        .pop-effect { position: absolute; font-size: 30px; animation: popUp 0.6s forwards; z-index: 150; pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="game-world">
        <div class="giant-tree"></div>
        <div id="stair-container"></div>
        <div id="rabbit">ğŸ°</div>
        <div id="rabbit-bubble" class="rabbit-speech"></div>
        <div id="monster">ğŸ§™â€â™‚ï¸</div>
    </div>

    <div id="ui-layer">
        <div id="quiz-box">
            <div id="progress-text"></div>
            <div id="timer">20</div>
            <div id="question"></div>
            <div id="options-container"></div>
        </div>
    </div>

    <div id="stats-screen">
        <h1 id="stats-title" style="color: #f57c00;">ê²°ê³¼ì°½</h1>
        <p id="stats-content"></p>
        <div id="reward-icon" style="font-size: 50px; margin: 10px;"></div>
        <button onclick="location.reload()" style="font-size: 18px; padding: 8px 20px; background: #ffa726; color: #fff; border: none; border-radius: 20px;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
</div>

<script>
    // ì˜¤ë””ì˜¤ ì„¤ì •
    const audioJump = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');
    const audioCorrect = new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3');
    const audioDing = new Audio('https://assets.mixkit.co/active_storage/sfx/1075/1075-preview.mp3');
    const audioBgm = new Audio('https://assets.mixkit.co/active_storage/sfx/123/123-preview.mp3'); // ê²½ì¾Œí•œ ë£¨í”„ìš© (ì˜ˆì‹œ)
    audioBgm.loop = true;

    const gameWorld = document.getElementById('game-world');
    const rabbit = document.getElementById('rabbit');
    const rabbitBubble = document.getElementById('rabbit-bubble');
    const monster = document.getElementById('monster');
    const quizBox = document.getElementById('quiz-box');
    const questionEl = document.getElementById('question');
    const optionsContainer = document.getElementById('options-container');
    const timerEl = document.getElementById('timer');
    const progressEl = document.getElementById('progress-text');
    const stairContainer = document.getElementById('stair-container');

    let currentLvl = 0;
    let score = 0;
    let timer;
    let timeLeft = 20;
    let correctVal = 0;
    const totalQuest = 20;

    const cheerMessages = [
        "ì•„ì¸ì•„, í˜ë‚´! í•  ìˆ˜ ìˆì–´!", "ì˜ì°¨ì˜ì°¨! ê±°ì˜ ë‹¤ ì™”ì–´!", "ì •ì•„ì¸ ìµœê³ ! ì •ë§ ì˜í•œë‹¤!",
        "í•˜ëŠ˜ ëê¹Œì§€ ê°€ë³´ì!", "ì •ë‹µ ìš”ì • ì•„ì¸ì´ í™”ì´íŒ…!", "ìš°ì™€! ì•„ì¸ì´ëŠ” ì²œì¬ì¸ê°€ë´!"
    ];

    function initStairs() {
        for (let i = 0; i < totalQuest + 5; i++) {
            const s = document.createElement('div');
            s.className = 'stair';
            const angle = i * 0.9;
            const x = Math.sin(angle) * 120 + (window.innerWidth / 2) - 65;
            const y = window.innerHeight - (i * 90) - 120;
            s.style.left = x + 'px';
            s.style.top = y + 'px';
            s.style.zIndex = Math.cos(angle) > 0 ? 6 : 2;
            stairContainer.appendChild(s);
        }
    }

    function updateCamera() {
        // í† ë¼ê°€ í™”ë©´ ì¤‘ì•™ ê·¼ì²˜ì— ì˜¤ë„ë¡ ë°°ê²½ì„ ì•„ë˜ë¡œ ë‚´ë¦¼
        const offset = currentLvl * 90;
        if (currentLvl > 3) {
            gameWorld.style.transform = `translateY(${offset - 270}px)`;
        }
    }

    function updateRabbitPosition() {
        const angle = currentLvl * 0.9;
        const x = Math.sin(angle) * 120 + (window.innerWidth / 2) - 35;
        const y = window.innerHeight - (currentLvl * 90) - 145; // ì •í™•íˆ ê³„ë‹¨ ìœ„ì— ì•ˆì°©í•˜ê²Œ ì¡°ì • (-195 -> -145)
        rabbit.style.left = x + 'px';
        rabbit.style.top = y + 'px';
        rabbit.style.zIndex = Math.cos(angle) > 0 ? 10 : 3;
        
        rabbitBubble.style.left = rabbit.style.left;
        rabbitBubble.style.top = rabbit.style.top;
    }

    // TTS ê¸°ëŠ¥: ê·€ì—¬ìš´ ëª©ì†Œë¦¬ë¡œ ì½ì–´ì£¼ê¸°
    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ko-KR';
        msg.rate = 1.2; // ì•½ê°„ ë¹ ë¥´ê²Œ í•´ì„œ ê·€ì—¬ìš´ ëŠë‚Œ
        msg.pitch = 1.5; // ë†’ì€ ìŒì¡°ë¡œ ì•„ì´ ëª©ì†Œë¦¬ ëŠë‚Œ
        window.speechSynthesis.speak(msg);
    }

    function showRabbitSpeech(msg) {
        rabbitBubble.innerText = msg;
        rabbitBubble.style.display = 'block';
        speak(msg); // ë§í’ì„  ëœ° ë•Œ ì½ì–´ì¤Œ
        setTimeout(() => rabbitBubble.style.display = 'none', 2500);
    }

    function makeQuiz() {
        let a, b;
        if (currentLvl <= 5) { a = Math.floor(Math.random() * 8) + 2; b = Math.floor(Math.random() * 8) + 1; }
        else if (currentLvl <= 15) { a = Math.floor(Math.random() * 15) + 10; b = Math.floor(Math.random() * 9) + 1; }
        else { a = Math.floor(Math.random() * 25) + 10; b = Math.floor(Math.random() * 25) + 10; }
        
        correctVal = a + b;
        questionEl.innerText = `${a} + ${b} = ?`;
        progressEl.innerText = `ë‚¨ì€ ë¬¸ì œ: ${totalQuest - currentLvl}ê°œ`;

        const options = [correctVal, correctVal + 1, correctVal - 1].sort(() => Math.random() - 0.5);
        optionsContainer.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt);
            optionsContainer.appendChild(btn);
        });
    }

    async function startTurn() {
        if (currentLvl >= totalQuest) { endGame(true); return; }

        audioJump.play();
        updateCamera(); // ë°°ê²½ ë¨¼ì € ë‚´ë¦¬ê¸°
        
        currentLvl++;
        updateRabbitPosition();

        setTimeout(() => {
            showRabbitSpeech(cheerMessages[Math.floor(Math.random() * cheerMessages.length)]);
            monster.style.display = 'block';
            monster.style.left = (parseInt(rabbit.style.left) + 40) + 'px';
            monster.style.top = (parseInt(rabbit.style.top) - 100) + 'px';
            quizBox.style.display = 'block';
            makeQuiz();
            startTimer();
        }, 800);
    }

    function startTimer() {
        timeLeft = 20;
        timerEl.innerText = `â± ${timeLeft}ì´ˆ`;
        audioBgm.play(); // íƒ€ì´ë¨¸ ì‹œì‘ ì‹œ ë°°ê²½ìŒì•…
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            timerEl.innerText = `â± ${timeLeft}ì´ˆ`;
            if (timeLeft === 10 || timeLeft === 5) audioDing.play();
            if (timeLeft <= 0) endGame(false, "ì‹œê°„ ì´ˆê³¼!");
        }, 1000);
    }

    function checkAnswer(val) {
        audioBgm.pause(); // ì •ë‹µ í™•ì¸ ì‹œ ìŒì•… ì¼ì‹œì •ì§€
        if (val === correctVal) {
            clearInterval(timer);
            score++;
            audioCorrect.play();
            quizBox.style.display = 'none';
            monster.style.display = 'none';
            setTimeout(startTurn, 500);
        } else {
            endGame(false, "ì•—! í‹€ë ¸ì–´.");
        }
    }

    function endGame(win, msg="") {
        audioBgm.pause();
        clearInterval(timer);
        quizBox.style.display = 'none';
        monster.style.display = 'none';
        const screen = document.getElementById('stats-screen');
        screen.style.display = 'block';
        const finalScore = (score / totalQuest) * 100;

        if (win) {
            document.getElementById('stats-title').innerText = "ì •ì•„ì¸ ìµœê³ ! ğŸ†";
            document.getElementById('stats-content').innerText = `ì „ë¶€ ë‹¤ ë§í˜”ì–´!\në‚´ ì ìˆ˜: 100ì !`;
            document.getElementById('reward-icon').innerText = "ğŸŸï¸ ì†Œì›ê¶Œ";
        } else {
            rabbit.style.display = 'none';
            document.getElementById('stats-title').innerText = "ì•„ì‰½ë‹¤! ì•—! ğŸ’¦";
            document.getElementById('stats-content').innerText = `${msg}\n${score}ë¬¸ì œë¥¼ ë§í˜”ì–´!\në‚´ ì ìˆ˜: ${finalScore}ì `;
            document.getElementById('reward-icon').innerText = "â­";
        }
    }

    initStairs();
    updateRabbitPosition();
    setTimeout(startTurn, 1000);
</script>
</body>
</html>
